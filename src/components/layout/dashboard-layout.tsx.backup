"use client"

import { useSession, signOut } from "next-auth/react"
import { useRouter } from "next/navigation"
import { useState } from "react"
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet"
import { Badge } from "@/components/ui/badge"
import { 
  // Layout and Navigation
  LayoutDashboard, 
  Home,
  Menu,
  ChevronDown,
  ChevronRight,
  Search,
  Filter,
  
  // User and Profile
  User, 
  Users,
  UserPlus,
  UserMinus,
  UserCheck,
  
  // Healthcare
  Heart,
  HeartPulse,
  Stethoscope,
  Hospital,
  Ambulance,
  Pill,
  Microscope,
  TestTube,
  Thermometer,
  Bandage,
  Syringe,
  FileText,
  ClipboardList,
  
  // Appointments and Scheduling
  Calendar, 
  CalendarDays,
  Clock,
  Clock3,
  
  // Communication
  MessageSquare, 
  Phone,
  PhoneCall,
  Video,
  MessageCircle,
  Mail,
  HelpCircle,
  Info,
  
  // Settings and Security
  Settings, 
  Settings2,
  Shield,
  ShieldAlert,
  Lock,
  Key,
  KeyRound,
  Fingerprint,
  
  // Analytics and Reports
  BarChart3,
  PieChart,
  LineChart,
  AreaChart,
  TrendingUp,
  TrendingDown,
  Target,
  
  // Financial
  CreditCard,
  DollarSign,
  Receipt,
  Banknote,
  
  // System and Admin
  Server,
  Database,
  HardDrive,
  Cpu,
  MemoryStick,
  Wifi,
  WifiOff,
  Battery,
  Zap,
  Activity,
  AlertTriangle,
  CheckCircle,
  XCircle,
  RefreshCw,
  
  // Organization
  Building,
  Building2,
  Network,
  Globe,
  
  // Actions
  LogOut,
  Bell,
  Edit,
  Eye,
  Download,
  Upload,
  PlusCircle,
  MinusCircle,
  Save,
  Share2,
  Printer,
  Star,
  MapPin,
  
  // Tools
  Wrench,
  Hammer,
  Tool,
  Layers,
  Package,
  Archive,
  Trash2,
  Clipboard,
  
  // Status
  BadgeCheck,
  Users2,
  Monitor
} from "lucide-react"
import { UserRole } from "@prisma/client"
import { hasPermission } from "@/lib/rbac"
import { NotificationSystem } from "@/components/notifications/notification-system"

interface DashboardLayoutProps {
  children: React.ReactNode
  userRole: UserRole
}

export function DashboardLayout({ children, userRole }: DashboardLayoutProps) {
  const { data: session } = useSession()
  const router = useRouter()
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)
  const [expandedSections, setExpandedSections] = useState<Record<string, boolean>>({})

  const handleSignOut = async () => {
    try {
      await signOut({ callbackUrl: "/auth/signin" })
    } catch (error) {
      console.error('Error signing out:', error)
      router.push('/auth/signin')
    }
  }

  const toggleSection = (section: string) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }))
  }

  const getNavigationItems = () => {
    const baseItems = [
      {
        title: "Dashboard",
        href: `/dashboard/${userRole.toLowerCase()}`,
        icon: LayoutDashboard,
        permission: "view_dashboard",
        description: "Overview and analytics"
      }
    ]

    const roleSpecificItems: Array<{
      title: string
      href: string
      icon: any
      permission: string
      description: string
      children?: Array<{
        title: string
        href: string
        icon: any
        permission: string
        description: string
      }>
    }> = []

    switch (userRole) {
      case "SUPER_ADMIN":
        roleSpecificItems.push(
          {
            title: "User Management",
            href: "#",
            icon: Users,
            permission: "manage_users",
            description: "Manage all system users",
            children: [
              {
                title: "Administrators",
                href: "/dashboard/super-admin/admins",
                icon: UserCheck,
                permission: "manage_admins",
                description: "Manage system administrators"
              },
              {
                title: "All Users",
                href: "/dashboard/super-admin/users",
                icon: Users,
                permission: "view_all_users",
                description: "View and manage all users"
              },
              {
                title: "User Roles",
                href: "/dashboard/super-admin/roles",
                icon: Shield,
                permission: "manage_roles",
                description: "Manage user roles and permissions"
              }
            ]
          },
          {
            title: "System Administration",
            href: "#",
            icon: Settings2,
            permission: "manage_system",
            description: "System-wide administration",
            children: [
              {
                title: "System Status",
                href: "/dashboard/super-admin/system-status",
                icon: Server,
                permission: "manage_system_status",
                description: "Monitor system health and performance"
              },
              {
                title: "Database Management",
                href: "/dashboard/super-admin/database",
                icon: Database,
                permission: "manage_database",
                description: "Database administration and backups"
              },
              {
                title: "Security Settings",
                href: "/dashboard/super-admin/security",
                icon: Shield,
                permission: "manage_security",
                description: "Security configuration and monitoring"
              },
              {
                title: "Feature Management",
                href: "/dashboard/super-admin/features",
                icon: Settings,
                permission: "manage_features",
                description: "Enable/disable system features"
              }
            ]
          },
          {
            title: "Analytics & Reporting",
            href: "#",
            icon: BarChart3,
            permission: "view_global_analytics",
            description: "System-wide analytics",
            children: [
              {
                title: "Global Analytics",
                href: "/dashboard/super-admin/analytics",
                icon: TrendingUp,
                permission: "view_global_analytics",
                description: "System-wide performance metrics"
              },
              {
                title: "Usage Reports",
                href: "/dashboard/super-admin/reports",
                icon: FileText,
                permission: "view_reports",
                description: "System usage and activity reports"
              },
              {
                title: "Audit Logs",
                href: "/dashboard/super-admin/audit-logs",
                icon: Activity,
                permission: "view_audit_logs",
                description: "System audit and access logs"
              }
            ]
          },
          {
            title: "Subscription Management",
            href: "#",
            icon: CreditCard,
            permission: "manage_subscriptions",
            description: "Manage subscriptions and billing",
            children: [
              {
                title: "Subscription Plans",
                href: "/dashboard/super-admin/subscription-plans",
                icon: DollarSign,
                permission: "manage_subscription_plans",
                description: "Manage subscription plans and pricing"
              },
              {
                title: "Subscription Requests",
                href: "/dashboard/super-admin/subscription-requests",
                icon: Clipboard,
                permission: "approve_subscription_requests",
                description: "Approve or reject subscription requests"
              },
              {
                title: "Billing & Payments",
                href: "/dashboard/super-admin/billing",
                icon: Receipt,
                permission: "manage_billing",
                description: "Manage billing and payments"
              }
            ]
          },
          {
            title: "Partner Management",
            href: "#",
            icon: Building2,
            permission: "manage_partners",
            description: "Manage healthcare partners",
            children: [
              {
                title: "Healthcare Partners",
                href: "/dashboard/super-admin/partners",
                icon: Hospital,
                permission: "manage_partners",
                description: "Manage healthcare organization partners"
              },
              {
                title: "Partner Analytics",
                href: "/dashboard/super-admin/partner-analytics",
                icon: BarChart3,
                permission: "view_partner_analytics",
                description: "Partner performance analytics"
              }
            ]
          }
        )
        break

      case "ADMIN":
        roleSpecificItems.push(
          {
            title: "User Management",
            href: "#",
            icon: Users,
            permission: "manage_users",
            description: "Manage network users",
            children: [
              {
                title: "Patients",
                href: "/dashboard/admin/patients",
                icon: User,
                permission: "manage_patients",
                description: "Manage patient accounts"
              },
              {
                title: "Doctors",
                href: "/dashboard/admin/doctors",
                icon: Stethoscope,
                permission: "manage_doctors",
                description: "Manage doctor profiles"
              },
              {
                title: "All Users",
                href: "/dashboard/admin/users",
                icon: Users,
                permission: "manage_users",
                description: "View and manage all users"
              },
              {
                title: "Control Room",
                href: "/dashboard/admin/control-room",
                icon: Monitor,
                permission: "manage_control_room",
                description: "Manage control room staff"
              },
              {
                title: "Attendants",
                href: "/dashboard/admin/attendants",
                icon: Users2,
                permission: "manage_attendants",
                description: "Manage attendant staff"
              }
            ]
          },
          {
            title: "Network Management",
            href: "#",
            icon: Network,
            permission: "manage_network",
            description: "Manage healthcare network",
            children: [
              {
                title: "Organizations",
                href: "/dashboard/admin/organizations",
                icon: Building,
                permission: "manage_organizations",
                description: "Manage healthcare organizations"
              },
              {
                title: "Network Settings",
                href: "/dashboard/admin/network",
                icon: Settings,
                permission: "manage_network_settings",
                description: "Configure network settings"
              }
            ]
          },
          {
            title: "Analytics & Reports",
            href: "#",
            icon: BarChart3,
            permission: "view_analytics",
            description: "Network analytics",
            children: [
              {
                title: "Network Analytics",
                href: "/dashboard/admin/analytics",
                icon: TrendingUp,
                permission: "view_analytics",
                description: "Network performance metrics"
              },
              {
                title: "Revenue Analytics",
                href: "/dashboard/admin/revenue",
                icon: DollarSign,
                permission: "view_analytics",
                description: "Revenue and financial analytics"
              },
              {
                title: "Consultation Analytics",
                href: "/dashboard/admin/consultations",
                icon: Calendar,
                permission: "view_analytics",
                description: "Consultation statistics and trends"
              },
              {
                title: "Audit Logs",
                href: "/dashboard/admin/audit-logs",
                icon: Activity,
                permission: "view_audit_logs",
                description: "Network activity logs"
              }
            ]
          },
          {
            title: "Communication",
            href: "#",
            icon: MessageSquare,
            permission: "manage_communications",
            description: "Manage communications",
            children: [
              {
                title: "Notifications",
                href: "/dashboard/admin/notifications",
                icon: Bell,
                permission: "manage_notifications",
                description: "Manage system notifications"
              },
              {
                title: "Messages",
                href: "/dashboard/admin/messages",
                icon: Mail,
                permission: "manage_messages",
                description: "Manage system messages"
              }
            ]
          }
        )
        break

      case "DOCTOR":
        roleSpecificItems.push(
          {
            title: "Appointments",
            href: "#",
            icon: Calendar,
            permission: "view_appointments",
            description: "Manage appointments",
            children: [
              {
                title: "My Appointments",
                href: "/dashboard/doctor/appointments",
                icon: CalendarDays,
                permission: "view_own_appointments",
                description: "View and manage your appointments"
              },
              {
                title: "Schedule",
                href: "/dashboard/doctor/schedule",
                icon: Clock,
                permission: "manage_schedule",
                description: "Manage your availability"
              }
            ]
          },
          {
            title: "Patients",
            href: "#",
            icon: Users,
            permission: "view_patients",
            description: "Patient management",
            children: [
              {
                title: "My Patients",
                href: "/dashboard/doctor/patients",
                icon: UserCheck,
                permission: "view_assigned_patients",
                description: "View your assigned patients"
              },
              {
                title: "Patient Records",
                href: "/dashboard/doctor/patient-records",
                icon: FileText,
                permission: "view_patient_records",
                description: "Access patient medical records"
              }
            ]
          },
          {
            title: "Clinical Tools",
            href: "#",
            icon: Stethoscope,
            permission: "use_clinical_tools",
            description: "Clinical tools and resources",
            children: [
              {
                title: "Prescriptions",
                href: "/dashboard/doctor/prescriptions",
                icon: Pill,
                permission: "manage_prescriptions",
                description: "Manage patient prescriptions"
              },
              {
                title: "Medical Notes",
                href: "/dashboard/doctor/medical-notes",
                icon: ClipboardList,
                permission: "manage_medical_notes",
                description: "Create and manage medical notes"
              },
              {
                title: "Lab Results",
                href: "/dashboard/doctor/lab-results",
                icon: TestTube,
                permission: "view_lab_results",
                description: "View patient lab results"
              }
            ]
          },
          {
            title: "Communication",
            href: "#",
            icon: MessageSquare,
            permission: "communicate_with_patients",
            description: "Patient communication",
            children: [
              {
                title: "Messages",
                href: "/dashboard/doctor/messages",
                icon: MessageCircle,
                permission: "send_messages",
                description: "Communicate with patients"
              },
              {
                title: "Video Consultations",
                href: "/dashboard/doctor/video-consultations",
                icon: Video,
                permission: "conduct_video_calls",
                description: "Conduct video consultations"
              }
            ]
          },
          {
            title: "Practice Analytics",
            href: "#",
            icon: BarChart3,
            permission: "view_earnings",
            description: "View your practice analytics",
            children: [
              {
                title: "Earnings Overview",
                href: "/dashboard/doctor/earnings",
                icon: DollarSign,
                permission: "view_earnings",
                description: "View your earnings and revenue"
              },
              {
                title: "Consultation Stats",
                href: "/dashboard/doctor/consultation-stats",
                icon: CalendarDays,
                permission: "view_earnings",
                description: "View consultation statistics"
              },
              {
                title: "Patient Analytics",
                href: "/dashboard/doctor/patient-analytics",
                icon: Users,
                permission: "view_earnings",
                description: "View patient demographics and trends"
              }
            ]
          }
        )
        break

      case "PATIENT":
        roleSpecificItems.push(
          {
            title: "Appointments",
            href: "#",
            icon: Calendar,
            permission: "view_own_appointments",
            description: "Manage your appointments",
            children: [
              {
                title: "My Appointments",
                href: "/dashboard/patient/appointments",
                icon: CalendarDays,
                permission: "view_own_appointments",
                description: "View and manage appointments"
              },
              {
                title: "Book Appointment",
                href: "/dashboard/patient/book-appointment",
                icon: PlusCircle,
                permission: "book_appointments",
                description: "Book new appointments"
              }
            ]
          },
          {
            title: "Health Records",
            href: "#",
            icon: FileText,
            permission: "view_own_health_records",
            description: "Your medical information",
            children: [
              {
                title: "Medical History",
                href: "/dashboard/patient/health-records",
                icon: HeartPulse,
                permission: "view_medical_history",
                description: "View your medical history"
              },
              {
                title: "Test Results",
                href: "/dashboard/patient/test-results",
                icon: TestTube,
                permission: "view_test_results",
                description: "View your test results"
              },
              {
                title: "Prescriptions",
                href: "/dashboard/patient/prescriptions",
                icon: Pill,
                permission: "view_prescriptions",
                description: "View your prescriptions"
              },
              {
                title: "Vitals",
                href: "/dashboard/patient/vitals",
                icon: Thermometer,
                permission: "view_vitals",
                description: "Track your vital signs"
              },
              {
                title: "Upload Records",
                href: "/dashboard/patient/upload-records",
                icon: Upload,
                permission: "upload_health_records",
                description: "Upload your health records"
              }
            ]
          },
          {
            title: "Billing & Payments",
            href: "#",
            icon: CreditCard,
            permission: "view_own_billing",
            description: "Manage your billing",
            children: [
              {
                title: "Billing History",
                href: "/dashboard/patient/billing",
                icon: Receipt,
                permission: "view_billing_history",
                description: "View your billing history"
              },
              {
                title: "Payment Methods",
                href: "/dashboard/patient/payment-methods",
                icon: CreditCard,
                permission: "manage_payment_methods",
                description: "Manage payment methods"
              }
            ]
          },
          {
            title: "Services",
            href: "#",
            icon: Stethoscope,
            permission: "book_services",
            description: "Book healthcare services",
            children: [
              {
                title: "Book Lab Tests",
                href: "/dashboard/patient/book-lab-tests",
                icon: TestTube,
                permission: "book_lab_tests",
                description: "Book laboratory tests"
              },
              {
                title: "Order Medicines",
                href: "/dashboard/patient/order-medicines",
                icon: Pill,
                permission: "order_medicines",
                description: "Order prescription medicines"
              },
              {
                title: "Emergency Services",
                href: "/dashboard/patient/emergency-services",
                icon: Ambulance,
                permission: "book_emergency_services",
                description: "Book emergency treatments"
              }
            ]
          },
          {
            title: "Health Pay Card",
            href: "#",
            icon: CreditCard,
            permission: "view_health_card",
            description: "Manage your Health Pay Card",
            children: [
              {
                title: "My Health Card",
                href: "/dashboard/patient/health-card",
                icon: CreditCard,
                permission: "view_health_card",
                description: "View your Health Pay Card details"
              },
              {
                title: "Card Benefits",
                href: "/dashboard/patient/card-benefits",
                icon: BadgeCheck,
                permission: "view_card_benefits",
                description: "View card benefits and discounts"
              },
              {
                title: "Transaction History",
                href: "/dashboard/patient/card-transactions",
                icon: Receipt,
                permission: "view_card_transactions",
                description: "View card transaction history"
              }
            ]
          },
          {
            title: "Partner Directory",
            href: "#",
            icon: Building2,
            permission: "view_partners",
            description: "Find healthcare partners",
            children: [
              {
                title: "Find Partners",
                href: "/dashboard/patient/find-partners",
                icon: Search,
                permission: "search_partners",
                description: "Search for healthcare partners"
              },
              {
                title: "Nearby Partners",
                href: "/dashboard/patient/nearby-partners",
                icon: MapPin,
                permission: "view_nearby_partners",
                description: "View partners in your area"
              },
              {
                title: "Partner Reviews",
                href: "/dashboard/patient/partner-reviews",
                icon: Star,
                permission: "view_partner_reviews",
                description: "Read and write partner reviews"
              }
            ]
          },
          {
            title: "Communication",
            href: "#",
            icon: MessageSquare,
            permission: "communicate_with_doctors",
            description: "Communicate with healthcare providers",
            children: [
              {
                title: "Messages",
                href: "/dashboard/patient/messages",
                icon: MessageCircle,
                permission: "send_messages",
                description: "Message your healthcare providers"
              },
              {
                title: "Video Consultations",
                href: "/dashboard/patient/video-consultations",
                icon: Video,
                permission: "join_video_calls",
                description: "Join video consultations"
              }
            ]
          }
        )
        break

      case "ATTENDANT":
        roleSpecificItems.push(
          {
            title: "Patient Management",
            href: "#",
            icon: Users,
            permission: "manage_patients",
            description: "Manage patients",
            children: [
              {
                title: "Patient Registration",
                href: "/dashboard/attendant/register-patient",
                icon: UserPlus,
                permission: "register_patients",
                description: "Register new patients"
              },
              {
                title: "Patient List",
                href: "/dashboard/attendant/patients",
                icon: Users,
                permission: "view_patients",
                description: "View and manage patients"
              }
            ]
          },
          {
            title: "Appointments",
            href: "#",
            icon: Calendar,
            permission: "manage_appointments",
            description: "Appointment management",
            children: [
              {
                title: "Schedule Appointments",
                href: "/dashboard/attendant/appointments",
                icon: CalendarDays,
                permission: "schedule_appointments",
                description: "Schedule patient appointments"
              },
              {
                title: "Appointment Queue",
                href: "/dashboard/attendant/appointment-queue",
                icon: Clock,
                permission: "manage_appointment_queue",
                description: "Manage appointment queue"
              }
            ]
          },
          {
            title: "Front Desk Operations",
            href: "#",
            icon: Building,
            permission: "manage_front_desk",
            description: "Front desk management",
            children: [
              {
                title: "Check-in/Check-out",
                href: "/dashboard/attendant/check-in-out",
                icon: UserCheck,
                permission: "manage_check_in_out",
                description: "Patient check-in and check-out"
              },
              {
                title: "Billing",
                href: "/dashboard/attendant/billing",
                icon: Receipt,
                permission: "process_billing",
                description: "Process patient billing"
              }
            ]
          }
        )
        break

      case "CONTROL_ROOM":
        roleSpecificItems.push(
          {
            title: "Live Monitoring",
            href: "#",
            icon: Monitor,
            permission: "monitor_appointments",
            description: "Real-time monitoring",
            children: [
              {
                title: "Live Appointments",
                href: "/dashboard/control-room/live-appointments",
                icon: Video,
                permission: "monitor_live_appointments",
                description: "Monitor live appointments"
              },
              {
                title: "Emergency Status",
                href: "/dashboard/control-room/emergency-status",
                icon: AlertTriangle,
                permission: "monitor_emergencies",
                description: "Monitor emergency situations"
              }
            ]
          },
          {
            title: "Appointment Management",
            href: "#",
            icon: Calendar,
            permission: "view_all_appointments",
            description: "Manage all appointments",
            children: [
              {
                title: "All Appointments",
                href: "/dashboard/control-room/all-appointments",
                icon: CalendarDays,
                permission: "view_all_appointments",
                description: "View all system appointments"
              },
              {
                title: "Doctor Assignment",
                href: "/dashboard/control-room/doctor-assignment",
                icon: Stethoscope,
                permission: "assign_doctors",
                description: "Assign doctors to appointments"
              }
            ]
          },
          {
            title: "System Analytics",
            href: "#",
            icon: BarChart3,
            permission: "view_analytics",
            description: "System performance",
            children: [
              {
                title: "Real-time Analytics",
                href: "/dashboard/control-room/analytics",
                icon: TrendingUp,
                permission: "view_real_time_analytics",
                description: "Real-time system analytics"
              },
              {
                title: "Resource Utilization",
                href: "/dashboard/control-room/resource-utilization",
                icon: Activity,
                permission: "view_resource_utilization",
                description: "Monitor resource utilization"
              }
            ]
          },
          {
            title: "Incident Management",
            href: "#",
            icon: AlertTriangle,
            permission: "manage_incidents",
            description: "Handle incidents",
            children: [
              {
                title: "Active Incidents",
                href: "/dashboard/control-room/incidents",
                icon: XCircle,
                permission: "view_incidents",
                description: "View and manage active incidents"
              },
              {
                title: "Escalations",
                href: "/dashboard/control-room/escalations",
                icon: RefreshCw,
                permission: "handle_escalations",
                description: "Handle escalations"
              }
            ]
          },
          {
            title: "Patient Support",
            href: "#",
            icon: HelpCircle,
            permission: "handle_escalations",
            description: "Patient assistance and support",
            children: [
              {
                title: "Support Requests",
                href: "/dashboard/control-room/support-requests",
                icon: MessageSquare,
                permission: "handle_escalations",
                description: "Manage patient support requests"
              },
              {
                title: "Feature Assistance",
                href: "/dashboard/control-room/feature-assistance",
                icon: Info,
                permission: "handle_escalations",
                description: "Help patients with platform features"
              },
              {
                title: "Issue Resolution",
                href: "/dashboard/control-room/issue-resolution",
                icon: CheckCircle,
                permission: "handle_escalations",
                description: "Resolve patient issues and complaints"
              }
            ]
          }
        )
        break

      case "ATTENDANT":
        roleSpecificItems.push(
          {
            title: "Patient Management",
            href: "#",
            icon: Users,
            permission: "manage_patients",
            description: "Manage patients",
            children: [
              {
                title: "Patient Registration",
                href: "/dashboard/attendant/register-patient",
                icon: UserPlus,
                permission: "register_patients",
                description: "Register new patients"
              },
              {
                title: "Patient List",
                href: "/dashboard/attendant/patients",
                icon: Users,
                permission: "manage_patients",
                description: "View and manage patients"
              },
              {
                title: "Patient Records",
                href: "/dashboard/attendant/patient-records",
                icon: FileText,
                permission: "view_patient_records",
                description: "Access patient records"
              }
            ]
          },
          {
            title: "Appointment Services",
            href: "#",
            icon: Calendar,
            permission: "book_appointments",
            description: "Appointment management",
            children: [
              {
                title: "Book Appointments",
                href: "/dashboard/attendant/book-appointment",
                icon: PlusCircle,
                permission: "book_appointments",
                description: "Book appointments for patients"
              },
              {
                title: "Appointment Queue",
                href: "/dashboard/attendant/appointment-queue",
                icon: Clock,
                permission: "view_appointments",
                description: "View appointment queue"
              },
              {
                title: "Schedule Management",
                href: "/dashboard/attendant/schedule",
                icon: CalendarDays,
                permission: "manage_schedule",
                description: "Manage appointment schedules"
              }
            ]
          },
          {
            title: "Front Desk Operations",
            href: "#",
            icon: Monitor,
            permission: "manage_patients",
            description: "Front desk management",
            children: [
              {
                title: "Check-in/Check-out",
                href: "/dashboard/attendant/check-in-out",
                icon: LogOut,
                permission: "manage_patients",
                description: "Patient check-in and check-out"
              },
              {
                title: "Billing Processing",
                href: "/dashboard/attendant/billing",
                icon: Receipt,
                permission: "manage_billing",
                description: "Process patient billing"
              },
              {
                title: "Payment Collection",
                href: "/dashboard/attendant/payments",
                icon: CreditCard,
                permission: "manage_payments",
                description: "Collect and manage payments"
              }
            ]
          }
        )

    // Always add settings for all roles
    roleSpecificItems.push(
      {
        title: "Settings",
        href: `/dashboard/${userRole.toLowerCase()}/settings`,
        icon: Settings,
        permission: "view_own_profile",
        description: "Account and profile settings"
      }
    )

    return [...baseItems, ...roleSpecificItems].filter(item => 
      hasPermission(userRole, item.permission)
    )
  }

  const navigationItems = getNavigationItems()
  const userInitials = session?.user?.name 
    ? session.user.name.split(' ').map(n => n[0]).join('').toUpperCase()
    : session?.user?.email?.[0]?.toUpperCase() || 'U'

  const getRoleDisplayName = (role: UserRole) => {
    switch (role) {
      case "PATIENT": return "Patient"
      case "DOCTOR": return "Doctor"
      case "ATTENDANT": return "Service Attendant"
      case "CONTROL_ROOM": return "Control Room"
      case "ADMIN": return "Network Administrator"
      case "SUPER_ADMIN": return "Super Administrator"
      default: return role
    }
  }

  const NavigationItem = ({ item, mobile = false, level = 0 }: { 
    item: any, 
    mobile?: boolean, 
    level?: number 
  }) => {
    const hasChildren = item.children && item.children.length > 0
    const isExpanded = expandedSections[item.title]

    if (hasChildren) {
      return (
        <div className="space-y-1">
          <button
            onClick={() => toggleSection(item.title)}
            className={`w-full flex items-center justify-between px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${
              mobile 
                ? 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
            } hover:scale-105 hover:shadow-md`}
          >
            <div className="flex items-center space-x-3">
              <item.icon className="h-5 w-5" />
              <div className="text-left">
                <span className="font-medium">{item.title}</span>
                <p className="text-xs text-gray-500 mt-1">{item.description}</p>
              </div>
            </div>
            {isExpanded ? <ChevronDown className="h-4 w-4" /> : <ChevronRight className="h-4 w-4" />}
          </button>
          
          {isExpanded && (
            <div className="ml-4 space-y-1">
              {item.children.map((child: any) => (
                <Link
                  key={child.href}
                  href={child.href}
                  className={`flex items-center space-x-3 px-4 py-2 rounded-lg text-sm transition-all duration-200 ${
                    mobile 
                      ? 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                      : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                  }`}
                  onClick={() => mobile && setIsMobileMenuOpen(false)}
                >
                  <child.icon className="h-4 w-4" />
                  <div className="text-left">
                    <span className="font-medium">{child.title}</span>
                    <p className="text-xs text-gray-500 mt-1">{child.description}</p>
                  </div>
                </Link>
              ))}
            </div>
          )}
        </div>
      )
    }

    return (
      <Link
        key={item.href}
        href={item.href}
        className={`flex items-center space-x-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${
          mobile 
            ? 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
            : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
        } hover:scale-105 hover:shadow-md`}
        onClick={() => mobile && setIsMobileMenuOpen(false)}
      >
        <item.icon className="h-5 w-5" />
        <div className="text-left">
          <span className="font-medium">{item.title}</span>
          <p className="text-xs text-gray-500 mt-1">{item.description}</p>
        </div>
      </Link>
    )
  }

  const Navigation = ({ mobile = false }: { mobile?: boolean }) => (
    <nav className={`space-y-2 ${mobile ? 'mt-6' : ''}`}>
      {navigationItems.map((item, index) => (
        <NavigationItem key={item.href} item={item} mobile={mobile} />
      ))}
    </nav>
  )

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-blue-50">
      {/* Header */}
      <header className="bg-white/95 backdrop-blur-sm shadow-lg border-b border-slate-200/50 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <Sheet open={isMobileMenuOpen} onOpenChange={setIsMobileMenuOpen}>
                <SheetTrigger asChild>
                  <Button variant="ghost" size="icon" className="lg:hidden text-blue-600 hover:bg-blue-50">
                    <Menu className="h-6 w-6" />
                  </Button>
                </SheetTrigger>
                <SheetContent side="left" className="w-80 bg-gradient-to-b from-white to-blue-50">
                  <div className="flex flex-col items-center space-x-2 mb-6 p-6">
                    <div className="w-12 h-12 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                      <Heart className="h-7 w-7 text-white" />
                    </div>
                    <div className="text-center">
                      <h1 className="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Fitwell
                      </h1>
                      <p className="text-sm text-gray-600 mt-1">H.E.A.L.T.H.</p>
                    </div>
                  </div>
                  <Navigation mobile />
                </SheetContent>
              </Sheet>
              
              <div className="flex items-center space-x-4">
                <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                  <Heart className="h-6 w-6 text-white" />
                </div>
                <div>
                  <h1 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    Fitwell
                  </h1>
                  <p className="text-xs text-gray-600">H.E.A.L.T.H.</p>
                </div>
              </div>
            </div>

            <div className="flex items-center space-x-4">
              <NotificationSystem />
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button variant="ghost" className="relative h-10 w-10 rounded-full border-2 border-blue-200 hover:border-blue-400 transition-all duration-200">
                    <Avatar className="h-9 w-9">
                      <AvatarImage src={session?.user?.image || ''} />
                      <AvatarFallback className="bg-gradient-to-br from-blue-600 to-purple-600 text-white text-sm font-medium">
                        {userInitials}
                      </AvatarFallback>
                    </Avatar>
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent className="w-80 backdrop-blur-sm bg-white/95 border border-blue-200 shadow-xl" align="end">
                  <DropdownMenuLabel className="font-normal p-4">
                    <div className="flex items-center space-x-3">
                      <Avatar className="h-12 w-12">
                        <AvatarImage src={session?.user?.image || ''} />
                        <AvatarFallback className="bg-gradient-to-br from-blue-600 to-purple-600 text-white text-lg font-medium">
                          {userInitials}
                        </AvatarFallback>
                      </Avatar>
                      <div className="flex flex-col space-y-1">
                        <p className="text-sm font-semibold text-gray-900">{session?.user?.name || 'User'}</p>
                        <p className="text-xs text-blue-600">{session?.user?.email}</p>
                        <Badge variant="secondary" className="w-fit bg-blue-50 text-blue-700 border-blue-200">
                          {getRoleDisplayName(userRole)}
                        </Badge>
                      </div>
                    </div>
                    
                    <div className="mt-4 pt-4 border-t border-blue-100 space-y-2">
                      <div className="flex items-center space-x-2 text-xs text-gray-600">
                        <Mail className="h-3 w-3" />
                        <span>{session?.user?.email || 'No email provided'}</span>
                      </div>
                      <div className="flex items-center space-x-2 text-xs text-gray-600">
                        <Clock className="h-3 w-3" />
                        <span>Last login: {new Date().toLocaleDateString()}</span>
                      </div>
                      <div className="flex items-center space-x-2 text-xs text-gray-600">
                        <BadgeCheck className="h-3 w-3 text-blue-600" />
                        <span>Verified account</span>
                      </div>
                    </div>
                  </DropdownMenuLabel>
                  <DropdownMenuSeparator className="bg-blue-100" />
                  <DropdownMenuItem onClick={() => router.push(`/dashboard/${userRole.toLowerCase()}/settings`)} className="text-gray-700 hover:bg-blue-50 hover:text-blue-700">
                    <User className="mr-2 h-4 w-4" />
                    <div>
                      <p className="font-medium">Profile Settings</p>
                      <p className="text-xs text-gray-500">Manage your profile information</p>
                    </div>
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => router.push(`/dashboard/${userRole.toLowerCase()}/settings`)} className="text-gray-700 hover:bg-blue-50 hover:text-blue-700">
                    <Settings className="mr-2 h-4 w-4" />
                    <div>
                      <p className="font-medium">Account Settings</p>
                      <p className="text-xs text-gray-500">Preferences and privacy</p>
                    </div>
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={() => router.push(`/dashboard/${userRole.toLowerCase()}/notifications`)} className="text-gray-700 hover:bg-blue-50 hover:text-blue-700">
                    <Bell className="mr-2 h-4 w-4" />
                    <div>
                      <p className="font-medium">Notification Settings</p>
                      <p className="text-xs text-gray-500">Manage notification preferences</p>
                    </div>
                  </DropdownMenuItem>
                  <DropdownMenuSeparator className="bg-blue-100" />
                  <DropdownMenuItem onClick={handleSignOut} className="text-red-600 hover:bg-red-50 hover:text-red-700">
                    <LogOut className="mr-2 h-4 w-4" />
                    <div>
                      <p className="font-medium">Sign out</p>
                      <p className="text-xs text-red-500">You'll need to sign in again</p>
                    </div>
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </div>
          </div>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar - Desktop */}
        <aside className="hidden lg:block w-80 bg-gradient-to-b from-white to-blue-50 shadow-xl border-r border-blue-200 min-h-screen">
          <div className="p-6">
            <div className="mb-6">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-lg font-semibold text-gray-900">Navigation</h2>
                <Badge variant="outline" className="text-xs bg-blue-50 text-blue-700 border-blue-200">
                  {getRoleDisplayName(userRole)}
                </Badge>
              </div>
            </div>
            <Navigation />
          </div>
        </aside>

        {/* Main Content */}
        <main className="flex-1 p-4 lg:p-8 max-w-7xl mx-auto w-full">
          <div className="bg-white/60 backdrop-blur-sm rounded-2xl shadow-lg border border-blue-200 p-6 lg:p-8">
            {children}
          </div>
        </main>
      </div>
    </div>
  )
}